WMStats.namespace("Globals");WMStats.Globals=function($){var _dbVariants={wmstats:"tier1",tier0_wmstats:"tier0"};function getReqDetailPrefix(){if(_dbVariants[dbname]=="tier1"){return"/reqmgr/view/details/"}else if(_dbVariants[dbname]=="analysis"){return"/an_reqmgr/view/details/"}else{return null}}function getAlertCollectorLink(){return"/couchdb/alertscollector/_design/AlertsCollector/index.html"}function getWorkloadSummaryPrefix(){return"/couchdb/"+getWorkloadSummaryDB()+"/_design/WorkloadSummary/_show/histogramByWorkflow/"}function getWorkloadSummaryDB(){if(_dbVariants[dbname]=="tier1"){return"workloadsummary"}else if(_dbVariants[dbname]=="analysis"){return"analysis_workloadsummary"}else if(_dbVariants[dbname]=="tier0"){return"t0_workloadsummary"}}function getAgentUrlForJobs(agentURL,workflow,status){return"http://"+agentURL.split(":")[0]+":5984/wmagent_jobdump%2Fjobs/_design/JobDump/_list/"+status+"Jobs/statusByWorkflowName?startkey=[%22"+workflow+"%22]&endkey=[%22"+workflow+"%22%2C{}]&reduce=false&stale=ok"}function formatJobLink(jobNumber,agentURLs,workflow,status){if(jobNumber!==0){if(agentURLs.constructor.name==="String"){agentURL=agentURLs}else if(agentURLs.length&&agentURLs[0].constructor.name==="String"){agentURL=agentURLs[0]}else{return jobNumber}return"<a href='"+getAgentUrlForJobs(agentURL,workflow,status)+"' target='_blank'>"+jobNumber+"</a>"}else{return jobNumber}}return{REQ_DETAIL_URL_PREFIX:getReqDetailPrefix(),WORKLOAD_SUMMARY_URL_PREFIX:getWorkloadSummaryPrefix(),AJAX_LOADING_STATUS:{beforeSend:function(){$("#loading_page").addClass("front").show()},complete:function(){$("#loading_page").hide()}},COUCHDB_NAME:dbname,WORKLOAD_SUMMARY_COUCHDB_NAME:getWorkloadSummaryDB(),REQMGR_COUCHDB_NAME:"reqmgr_workload_cache",VARIANT:_dbVariants[dbname],COUCHAPP_DESIGN:"WMStats",WORKLOAD_SUMMARY_COUCHAPP_DESIGN:"WorkloadSummary",REQMGR_COUCHAPP_DESIGN:"ReqMgr",ALERT_COLLECTOR_LINK:getAlertCollectorLink(),CONFIG:null,loadScript:function(url,success){$.ajax({async:false,url:url,dataType:"script",success:success})},importScripts:function(scripts){for(var i=0;i<scripts.length;i++){document.write('<script src="'+scripts[i]+'"></script>')}},Event:{},formatJobLink:formatJobLink}}(jQuery);WMStats.namespace("CustomEvents");WMStats.CustomEvents.REQUESTS_LOADED="C_1";WMStats.CustomEvents.AGENTS_LOADED="C_2";WMStats.CustomEvents.REQUEST_SUMMARY_READY="C_3";WMStats.CustomEvents.CATEGORY_SUMMARY_READY="C_4";WMStats.CustomEvents.REQUEST_DETAIL_READY="C_5";WMStats.CustomEvents.CATEGORY_DETAIL_READY="C_6";WMStats.CustomEvents.JOB_SUMMARY_READY="C_7";WMStats.CustomEvents.JOB_DETAIL_READY="C_8";WMStats.CustomEvents.LOADING_DIV_START="C_9";WMStats.CustomEvents.LOADING_DIV_END="C_10";WMStats.CustomEvents.HISTORY_LOADED="C_11";WMStats.CustomEvents.AJAX_LOADING_START="C_12";WMStats.CustomEvents.RESUBMISSION_SUMMARY_READY="C_13";WMStats.CustomEvents.RESUBMISSION_SUCCESS="C_14";WMStats.CustomEvents.WORKLOAD_SUMMARY_READY="W_1";WMStats.namespace("ViewModel");WMStats.ViewModel.Resubmission={};WMStats.namespace("Utils");WMStats.Utils.cloneObj=function(sourceObj){if(typeof sourceObj==="object"){var newObj=sourceObj.constructor();for(var prop in sourceObj){newObj[prop]=WMStats.Utils.cloneObj(sourceObj[prop])}return newObj}else{return sourceObj}};WMStats.Utils.updateObj=function(baseObj,additionObj,createFlag,updateFunc){for(var field in additionObj){if(!baseObj[field]){if(createFlag===undefined||createFlag){baseObj[field]=WMStats.Utils.cloneObj(additionObj[field])}}else{if(typeof baseObj[field]=="object"){WMStats.Utils.updateObj(baseObj[field],additionObj[field],createFlag,updateFunc)}else{if(updateFunc instanceof Function){updateFunc(baseObj,additionObj,field)}else{baseObj[field]+=additionObj[field]}}}}};WMStats.Utils.getOrDefault=function(baseObj,objList,val){if(baseObj[objList[0]]){if(objList.length==1){return baseObj[objList[0]]}else{return WMStats.Utils.getOrDefault(baseObj[objList[0]],objList.slice(1),val)}}else{return val}};WMStats.Utils.get=function(baseObj,objStr,val){if(baseObj===undefined){return val}objList=objStr.split(".");return WMStats.Utils.getOrDefault(baseObj,objList,val)};WMStats.Utils.formatReqDetailUrl=function(request){return'<a href="'+WMStats.Globals.REQ_DETAIL_URL_PREFIX+encodeURIComponent(request)+'" target="requestDetailFrame">'+request+"</a>"};WMStats.Utils.formatWorkloadSummarylUrl=function(request,status){if(status===undefined){return'<a href="'+WMStats.Globals.WORKLOAD_SUMMARY_URL_PREFIX+encodeURIComponent(request)+'" target="workloadSummaryFrame">'+request+"</a>"}else if(status=="completed"||status=="announced"||status=="closed-out"||status.indexOf("archived")!==-1){return'<a href="'+WMStats.Globals.WORKLOAD_SUMMARY_URL_PREFIX+encodeURIComponent(request)+'" target="workloadSummaryFrame">'+status+"</a>"}else{return status}};WMStats.Utils.formatDate=function(timestamp){var date=new Date(timestamp*1e3);return date.getFullYear()+"-"+date.getMonth()+"-"+date.getDate()+" "+date.getHours()+":"+date.getMinutes()};WMStats.Utils.foramtDuration=function(timestamp){if(timestamp==-1)return"N/A";var totalMin=Math.floor(timestamp/60);var hours=Math.floor(totalMin/60);var min=totalMin%60;return hours+" h "+min+" m"};WMStats.Utils.createInputFilter=function(selector){var a=$(selector).serializeArray(),filter={};$.each(a,function(i,obj){filter[obj.name]=obj.value});return filter};WMStats.Utils.formatDetailButton=function(name){return'<div class="detailButton" name="'+name+'"></div>'};WMStats.Utils.utcClock=function(date){function appendZero(num){if(num<10){return"0"+num}return num}var day=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var now;if(date===undefined){now=new Date}else{now=date}var month=now.getUTCMonth()+1;var utcString=now.getUTCFullYear()+"/"+month+"/"+now.getUTCDate()+" ("+day[now.getUTCDay()]+") "+appendZero(now.getUTCHours())+":"+appendZero(now.getUTCMinutes())+":"+appendZero(now.getUTCSeconds())+" UTC";return utcString};WMStats.Utils.expandFormat=function(dataArray,summaryStr,formatFunc){var htmlstr="";if(dataArray==undefined||typeof dataArray!=="object"||dataArray.length==0){htmlstr+="<strong>"+summaryStr+":</strong>"}else{htmlstr+="<details> <summary><strong>"+summaryStr+"</strong></summary><ul>";if(formatFunc===undefined){formatFunc=function(x){return x}}for(var i in dataArray){htmlstr+="<li>"+formatFunc(dataArray[i],i)+"</li>"}htmlstr+="</ul></details>"}return htmlstr};WMStats.Utils.largeNumberFormat=function(number){var mega=1e6;var giga=1e9;if(number<mega){return number}else if(number<giga){return(number/mega).toFixed(1)+" M"}else{return(number/giga).toFixed(1)+" G"}};WMStats.Utils.splitCouchServiceURL=function(url){var urlArray=url.split("/");return{couchUrl:urlArray.slice(0,-1).join("/"),couchdb:urlArray[urlArray.length-1]}};WMStats.Utils.acdcRequestSting=function(originalRequest,requestor){var stripRequestor=originalRequest.replace(new RegExp("^"+requestor),"ACDC");return stripRequestor.replace(/_\d+_\d+_\d+$/,"")};WMStats.Utils.contains=function(value,container){if(container.constructor.name==="Array"){for(var index in container){if(value==container[index]){return index}}return-1}if(container.constructor.name==="Object"){for(var index in container){if(value==index){return index}}return-1}};WMStats.Utils.addToSet=function(array,value){if(WMStats.Utils.contains(value,array)===-1){array.push(value);return true}else{return false}};WMStats.namespace("CouchBase");WMStats.namespace("Couch");WMStats.namespace("WorkloadSummaryCouch");WMStats.namespace("ReqMgrCouch");WMStats.CouchBase=function(dbName,designName){var _Design=designName;var _couchDB=$.couch.db(dbName);var _config;function _combineOption(options,callback,ajaxOptions){var options=options||{};options.success=callback;if(ajaxOptions){for(var opt in ajaxOptions){options[opt]=ajaxOptions[opt]}}return options}function loadConfig(func){function callback(data){var config;if(!data.rows&&data.rows.length!=1){config=null}else{config=data.rows[0].doc}WMStats.Globals.CONFIG=config;func()}_couchDB.view(_Design+"/config",_combineOption({include_docs:true},callback))}function view(name,options,callback,ajaxOptions){var options=options||{};if(options.stale===undefined){options.stale="update_after"}return _couchDB.view(_Design+"/"+name,_combineOption(options,callback,ajaxOptions))}function allDocs(options,callback,ajaxOptions){return _couchDB.allDocs(_combineOption(options,callback,ajaxOptions))}function openDoc(docId,callback){return _couchDB.openDoc(docId,_combineOption({},callback))}return{loadConfig:loadConfig,view:view,allDocs:allDocs,openDoc:openDoc}};WMStats.Couch=WMStats.CouchBase(WMStats.Globals.COUCHDB_NAME,WMStats.Globals.COUCHAPP_DESIGN);WMStats.WorkloadSummaryCouch=WMStats.CouchBase(WMStats.Globals.WORKLOAD_SUMMARY_COUCHDB_NAME,WMStats.Globals.WORKLOAD_SUMMARY_COUCHAPP_DESIGN);WMStats.ReqMgrCouch=WMStats.CouchBase(WMStats.Globals.REQMGR_COUCHDB_NAME,WMStats.Globals.REQMGR_SUMMARY_COUCHAPP_DESIGN);WMStats.namespace("Ajax");WMStats.Ajax=function($){var reqMgrFuncs={putRequest:function(requestArgs){$.ajax("/reqmgr/reqMgr/request",{type:"PUT",headers:{Accept:"application/json","Content-Type":"application/json"},data:JSON.stringify(requestArgs),processData:false,success:function(data,textStatus,jqXHR){var requestName=data["WMCore.RequestManager.DataStructs.Request.Request"].RequestName;$(WMStats.Globals.Event).triggerHandler(WMStats.CustomEvents.RESUBMISSION_SUCCESS,requestName)},error:function(jqXHR,textStatus,errorThrown){alert(jqXHR.responseText)}})}};var phedexFuncs={getPFN:function(location,lfn){$.ajax("/phedex/datasvc/json/prod/lfn2pfn",{type:"GET",headers:{Accept:"application/json"},data:{node:location,protocol:"srmv2",lfn:lfn},processData:false,success:function(data,textStatus,jqXHR){var mappedData=data.phedex.mapping;var pfns=[];for(var i in mappedData){pfns.push(mappedData[i].pfn)}$(WMStats.Globals.Event).triggerHandler(WMStats.CustomEvents.PHEDEX_PFN_SUCCESS,pfns)},error:function(jqXHR,textStatus,errorThrown){alert(jqXHR.responseText)}})}};return{requestMgr:reqMgrFuncs,phedex:phedexFuncs}}(jQuery);