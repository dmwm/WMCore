// update function
// input: valueKey (what to change), value - new value
function(doc, req) {
    if (doc === null) {
    	return [null, "Error: document not found"];
    };
    
    function updateTransition(key) {
        var keyAllowed = {"RequestStatus": "RequestTransition",
                          "RequestPriority": "PriorityTransition"};
        var keyMap = {"RequestStatus": "Status",
                      "RequestPriority": "Priority"};

        var transitionKey = keyAllowed[key]
        if (transitionKey === undefined) {
            return
        }

        var currentTS =  Math.round((new Date()).getTime() / 1000);
        var dn = doc.DN || null;
        var statusObj = {"UpdateTime": currentTS, "DN": dn};
        statusObj[keyMap[key]] = doc[key];

        if (!doc[transitionKey]) {
            doc[transitionKey] = new Array();
            doc[transitionKey].push(statusObj);
        } else {
            doc[transitionKey].push(statusObj);
        }
    }

    // req.query is dictionary fields into the 
    // CMSCouch.Database.updateDocument() method, which is a dictionary
    function isEmpty(obj) {
        for(var prop in obj) {
            if(obj.hasOwnProperty(prop))
                return false;
        }
        return true;
    }

    function updateTaskStepChain(chainType, prop, value) {
        if (doc[chainType + "Chain"]) {
            var numChain = doc[chainType + "Chain"];
            for (var i=1; i <= numChain; i++) {
                if (doc[chainType + i] && doc[chainType + i][prop] && 
                    value.hasOwnProperty(doc[chainType + i][chainType + "Name"])) {
                    
                    doc[chainType + i][prop] = value[doc[chainType + i][chainType + "Name"]];
                }
            }
        }
    }

    // req.query is dictionary fields into the 
    // CMSCouch.Database.updateDocument() method, which is a dictionary
 
    //TODO: only accepts request body for the argument
    var fromQuery = false;
    
    var newValues = {};
    if (isEmpty(req.query)) {
        newValues = JSON.parse(req.body);
    } else {
        fromQuery = true;
        newValues = req.query;
    }
    
    for (key in newValues)
    {
    
        if (fromQuery) {
            if (key == "RequestTransition" ||
                key == "PriorityTransition" ||
                key == "SiteWhitelist" ||
                key == "SiteBlacklist" ||
                key == "BlockWhitelist" ||
                key == "CMSSWVersion" ||
                key == "InputDataset" ||
                key == "OutputDatasets" ||
                key == "CustodialSites" ||
                key == "NonCustodialSites" ||
                key == "AutoApproveSubscriptionSites" ||
                key == "OutputModulesLFNBases") {

               doc[key] = JSON.parse(newValues[key]);
           }
        }

        doc[key] = newValues[key];

        // If key is RequestStatus, also update the transition
        updateTransition(key);
        
        updateTaskStepChain("Task", key, newValues[key]);
        updateTaskStepChain("Step", key, newValues[key]);
    }
    return [doc, "OK"];
}
