#!/usr/bin/env python

""" requestDb """
import sys
import getopt
import os
import WMCore.RequestManager.RequestDB.Interface.Request.ListRequests as ListRequests
import WMCore.RequestManager.RequestDB.Interface.Request.GetRequest as GetRequest
import WMCore.RequestManager.RequestDB.Interface.Admin.RequestManagement as RequestAdmin
from WMCore.WMInit import WMInit
from WMCore.Configuration import loadConfigurationFile
import logging




valid = 's:g:t:p:u:'

usage = \
"""
requestDb (list|delete) [-s <status>] [-g <group>] [-t <team>] [-p <prodmgr>] [-u <user>]
"""

group = None
team = None
status = None
prodMgr = None
user = None

if len(sys.argv) < 2:
    print usage
    sys.exit(1)

try:
    opts, args = getopt.getopt(sys.argv[2:], valid)
except getopt.GetoptError, ex:
    print usage
    print str(ex)
    sys.exit(1)

# load the configuration
path = __file__.rsplit('/',1)[0]
defaultConfig = path+'/../src/python/WMCore/HTTPFrontEnd/RequestManager/DefaultConfig.py'
if not os.path.exists(defaultConfig):
    print "Cannot find " + defaultConfig
    sys.exit(1)
config = loadConfigurationFile(defaultConfig)

if not hasattr(config, "CoreDatabase"):
    print "Your config is missing the CoreDatabase section."
    sys.exit(1)

socketLoc = getattr(config.CoreDatabase, "socket", None)
connectUrl = getattr(config.CoreDatabase, "connectUrl", None)
(dialect, junk) = connectUrl.split(":", 1)

wmInit = WMInit()
wmInit.setDatabaseConnection(dbConfig = connectUrl, dialect = dialect,
                             socketLoc = socketLoc)
wmInit.setLogging(logLevel = logging.DEBUG)

for opt, arg in opts:
    if opt == "-s":
        status = arg
    if opt == "-g":
        group = arg
    if opt == "-t":
        team = arg
    if opt == "-p":
        prodMgr = arg
    if opt == "-u":
        user = arg

def getList():
    if len(opts) == 0:
        return ListRequests.listRequests()
    # These methods only return IDs
    ids  = []
    if status != None and len(opts) == 1:
        ids.extend(ListRequests.listRequestsByStatus(status))
    else:
        if group != None:
            ids.extend(ListRequests.listRequestsForGroup(group, status).values())
        if team != None:
            ids.extend(ListRequests.listRequestsByTeam(team, status).values())
        if prodMgr != None:
            ids.extend(ListRequests.listRequestsByProdMgr(prodMgr).values())
    print str(ids)
    return [GetRequest.getRequest(id) for id in ids]

def doDelete():
    requests = getList()
    print str(args)
    for request in requests:
        if request['RequestName'] in args:
            print "Deleting " + request['RequestName']
            RequestAdmin.deleteRequest(request["RequestID"])

if sys.argv[1] == 'list':
    for request in getList():
        print str(request)
elif sys.argv[1] == 'delete':
    doDelete()
else:
    print usage
    sys.exit(1)


