#!/usr/bin/env python
"""
Commands for initializing the proper database tables
or cleaning the database.
"""

__revision__ = "$Id: wmcore-db-init,v 1.10 2010/07/05 03:05:32 meloam Exp $"
__version__ = "$Revision: 1.10 $"
__author__ = "fvlingen@caltech.edu"

import getopt
import logging
import os
import sys
import time

logging.basicConfig(level=logging.DEBUG)

from WMCore.Configuration import loadConfigurationFile
from WMCore.WMFactory import WMFactory
from WMCore.WMInit import WMInit
from sqlalchemy.engine.url import make_url

def usage():

    msg = """
Usage: wmcore-db-init [--config] (--create | --clear )<options>

You must either set the WMAGENT_CONFIG environment variable or specify the config file with
--config 

options
--modules= comma separated list of modules whose tables
need to be created.
"""
    print(msg)


valid = ['config=', 'create', 'clear', 'modules=']

try:
    opts, args = getopt.getopt(sys.argv[1:], "", valid)
except getopt.GetoptError, ex:
    print str(ex)
    usage()
    sys.exit(1)

config = None
command = None
modules = []

for opt, arg in opts:
    if opt == "--create":
        if command != None:
            msg = "Command specified twice:\n"
            msg += usage()
            print msg
            sys.exit(1)
        command = "create"
    if opt == "--clear":
        if command != None:
            msg = "Command specified twice:\n"
            msg += usage()
            print msg
            sys.exit(1)
        command = "clear"
    if opt == "--modules":
        modules = arg.split(',')
    if opt == "--config":
        config = arg
   
if command == None:
    msg = "No command specified\n"
    print(msg)
    usage()
    sys.exit(0)

if config == None:            
    config = os.environ.get("WMAGENT_CONFIG", None)

    if config == None:
        msg = "No Config file provided\n"
        msg += "provide one with the --config option"
        print(msg)
        usage()
        sys.exit(1) 

if not os.path.exists(config):
    print "Can't find config: %s" % config
    sys.exit(1)

# load the config file here.
cfgObject = loadConfigurationFile(config)

wmInit = WMInit()

def connectionTest(config):
    """
    _connectionTest_

    Create a DB Connection instance to test the connection specified
    in the config file.

    """
    print 'checking default database connection'

    (dialect, junk) = config.CoreDatabase.connectUrl.split(":", 1)
    socket = getattr(config.CoreDatabase, "socket", None)

    try:
       wmInit.setLogging('wmcoreD', 'wmcoreD', logExists = False, logLevel = logging.DEBUG)
       wmInit.setDatabaseConnection(dbConfig = config.CoreDatabase.connectUrl,
                                    dialect = dialect,
                                    socketLoc = socket)
    except Exception, ex:
        msg = "Unable to make connection to using \n"
        msg += "parameters provided in %s\n" % config.CoreDatabase.connectUrl
        msg += str(ex)
        print msg
        raise ex
    print 'default database connection tested'

def create(config):
    params = {}

    if hasattr(config.CoreDatabase, "tablespaceName"):
        params["tablespace_table"] = config.CoreDatabase.tablespaceName
    if hasattr(config.CoreDatabase, "indexspaceName"):
        params["tablespace_index"] = config.CoreDatabase.indexspaceName

    wmInit.setSchema(modules, params = params) 
    return

def executeCommand(command):
    stdin,stdout,stderr = os.popen3(command)
    for x in [stdout, stderr]:
        line = x.read()
        while line:
            print(line)
            line = x.read()
    

def clear(config):
    dbUrl = make_url(config.CoreDatabase.connectUrl)
    
    if dbUrl.drivername.lower() == 'mysql':
        #TODO: if it is necessary for only master user perform this task,
        #use master user account and grant permission to the user. 
        #(currently commented out)    
        if dbUrl.password == None:
            dbUrl.password = ''
        command1 = 'mysql -u '+ dbUrl.username + ' --password='+dbUrl.password+' -h '+ dbUrl.host + ' -P ' + str(dbUrl.port) + " --exec "
        print command1
        command = command1+' "drop database if exists '+ dbUrl.database +'"'
        executeCommand(command)
        command = command1+' "create database '+ dbUrl.database +'"'
        executeCommand(command)
        #command = command1+' "GRANT ALL PRIVILEGES ON '+ dbUrl.database +\
        #    ".* TO '"+ dbUrl.username +"'@'"+ dbUrl.host +\
        #    "' IDENTIFIED BY '"+ dbUrl.password+"' WITH GRANT OPTION"+'"'
        #executeCommand(command)

if command == "create":
    connectionTest(cfgObject)
    create(cfgObject)
    sys.exit(0)

elif command == "clear":
    clear(cfgObject)
    sys.exit(0)
