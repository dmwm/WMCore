WMStats.namespace("_StructBase");WMStats._StructBase=function(){this._data=null};WMStats._StructBase.prototype={getData:function(){return this._data},setData:function(couchData){this._data=this.convertCouchData(couchData)}};WMStats.namespace("GenericRequests");WMStats.namespace("GenericRequestsSummary");WMStats.namespace("RequestsByKey");WMStats.GenericRequestsSummary=function(summaryStruct){this._get=WMStats.Utils.get;this._addJobs=WMStats.Utils.updateObj;this.summaryStruct={length:0};this.jobStatus={success:0,canceled:0,transition:0,queued:{first:0,retry:0},submitted:{first:0,retry:0},submitted:{pending:0,running:0},failure:{create:0,submit:0,exception:0},cooloff:{create:0,submit:0,job:0},paused:{create:0,submit:0,job:0}};if(summaryStruct){this.summaryStruct=WMStats.Utils.cloneObj(summaryStruct)}};WMStats.GenericRequestsSummary.prototype={getJobStatus:function(statusStr){return WMStats.Utils.get(this.jobStatus,statusStr,0)},getSummary:function(){return this.summaryStruct},summaryStructUpdateFuction:null,update:function(summary){WMStats.Utils.updateObj(this.summaryStruct,summary.summaryStruct,true,this.summaryStructUpdateFuction);WMStats.Utils.updateObj(this.jobStatus,summary.jobStatus)},updateFromRequestDoc:function(doc){var summary=this.createSummaryFromRequestDoc(doc);this.update(summary)},getWMBSTotalJobs:function(){return this.getJobStatus("success")+this.getJobStatus("canceled")+this.getJobStatus("transition")+this.getTotalFailure()+this.getTotalCooloff()+this.getTotalPaused()+this.getTotalQueued()+this.getTotalSubmitted()},getTotalFailure:function(){return this.getJobStatus("failure.create")+this.getJobStatus("failure.submit")+this.getJobStatus("failure.exception")},getTotalSubmitted:function(){return this.getJobStatus("submitted.first")+this.getJobStatus("submitted.retry")},getTotalCooloff:function(){return this.getJobStatus("cooloff.create")+this.getJobStatus("cooloff.submit")+this.getJobStatus("cooloff.job")},getTotalPaused:function(){return this.getJobStatus("paused.create")+this.getJobStatus("paused.submit")+this.getJobStatus("paused.job")},getTotalQueued:function(){return this.getJobStatus("queued.first")+this.getJobStatus("queued.retry")},createSummaryFromRequestDoc:function(doc){var summary=WMStats.RequestsSummary();summary.summaryStruct.length=1;summary.jobStatus=this._get(doc,"status",{});return summary}};WMStats.GenericRequests=function(noFilterFlag){this._dataByWorkflow={};this._dataByWorkflowAgent={};this._get=WMStats.Utils.get;this._addJobs=WMStats.Utils.updateObj;this._filter={};this._filteredRequests=null};WMStats.GenericRequests.prototype={_mapProperty:function(workflowData,property){if(property=="request_status"){return workflowData[property][workflowData[property].length-1].status}return workflowData[property]},_getRequestObj:function(request){if(typeof request=="string"){return this.getDataByWorkflow(request)}else{return request}},_getStatusObj:function(request,level){var requestObj=this._getRequestObj(request);if(level=="task"){return requestObj.tasks.status}else if(level=="site"){return requestObj.sites}else{return requestObj.status}},_requestDateSort:function(a,b){for(var i in a.request_date){if(b.request_date[i]!=a.request_date[i]){return Number(b.request_date[i])-Number(a.request_date[i])}}return 0},_andFilter:function(base,filter){var includeFlag=true;for(var property in filter){if(!filter[property]){continue}else if(this._mapProperty(base,property)!==undefined&&this._contains(this._mapProperty(base,property),filter[property])){continue}else{includeFlag=false;break}}return includeFlag},_contains:function(a,b){if(typeof a==="string")return a.toLowerCase().indexOf(b.toLowerCase())!==-1;else if(typeof a=="number")return Number(b)==a;else if(a instanceof Array){for(var i in a){if(this._contains(a[i],b))return true}return false}else{alert("value need to be either number or string")}},getFilter:function(){return this._filter},setFilter:function(filter){this._filter=filter},updateRequest:function(doc){var request=this.getDataByWorkflow(doc.workflow);if(!request){this._dataByWorkflow[doc.workflow]={}}var requestWithAgent=this.getRequestByNameAndAgent(doc.workflow,doc.agent_url);for(var field in doc){if(this._dataByWorkflow[doc.workflow][field]&&(field=="sites"||field=="status")){this._addJobs(this._dataByWorkflow[doc.workflow][field],doc[field])}else if(this._dataByWorkflow[doc.workflow][field]&&field=="output_progress"){var outProgress=this._dataByWorkflow[doc.workflow].output_progress;for(var index in outProgress){for(var prop in doc[field][index]){outProgress[index][prop]+=doc[field][index][prop]}}}else{this._dataByWorkflow[doc.workflow][field]=doc[field]}requestWithAgent[field]=doc[field]}},updateBulkRequests:function(docList){for(var row in docList){if(docList[row].doc){this.updateRequest(docList[row].doc)}}},filterRequests:function(){var requestData=this.getDataByWorkflow();var filteredData={};for(var workflowName in requestData){if(this._andFilter(requestData[workflowName],this._filter)){filteredData[workflowName]=requestData[workflowName]}}this._filteredRequests=WMStats.Requests();this._filteredRequests.setDataByWorkflow(filteredData);return this._filteredRequests},getRequestByNameAndAgent:function(workflow,agentUrl){if(!this._dataByWorkflowAgent[workflow]){this._dataByWorkflowAgent[workflow]={}}if(!agentUrl){return this._dataByWorkflowAgent[workflow]}else{if(!this._dataByWorkflowAgent[workflow][agentUrl]){this._dataByWorkflowAgent[workflow][agentUrl]={}}return this._dataByWorkflowAgent[workflow][agentUrl]}},getDataByWorkflow:function(request,keyString,defaultVal){"keyString is opject property separte by .";if(!request)return this._dataByWorkflow;else if(!keyString)return this._dataByWorkflow[request];else return this._get(this._dataByWorkflow[request],keyString,defaultVal)},getData:function(workflow){if(workflow){var requestsObj={};requestsObj[workflow]=this._dataByWorkflow[workflow];return{requests:requestsObj,summary:this.getSummary(workflow),key:workflow}}return this._dataByWorkflow},getFilteredRequests:function(){return this._filteredRequests},setDataByWorkflow:function(data){"keyString is opject property separte by .";this._dataByWorkflow=data},getList:function(sortFunc){var list=[];for(var request in this.getDataByWorkflow()){list.push(this.getDataByWorkflow(request))}if(sortFunc){return list.sort(sortFunc)}else{return list.sort(this._requestDateSort)}},getSummary:function(workflow){var summary=WMStats.RequestsSummary();if(workflow){return summary.createSummaryFromRequestDoc(this.getDataByWorkflow(workflow))}else{for(var request in this.getDataByWorkflow()){summary.updateFromRequestDoc(this.getDataByWorkflow(request))}return summary}},getAlertRequests:function(){var alertRequests=[];for(var workflow in this.getDataByWorkflow()){var reqSummary=this.getSummary(workflow);var coolOff=reqSummary.getTotalCooloff();var paused=reqSummary.getTotalPaused();if(coolOff>0||paused>0){alertRequests.push(this.getData(workflow))}}return alertRequests},getRequestStatusAndTime:function(workflowName){var workflowData=this._dataByWorkflow[workflowName];return workflowData["request_status"][workflowData["request_status"].length-1]}};WMStats.RequestsByKey=function(category,summaryFunc){var _data={};var _category=category;var _get=WMStats.Utils.get;function categorize(requestData){function _updateData(key,summaryBase){if(_data[key]===undefined){_data[key]={};_data[key].requests={};_data[key].summary=summaryFunc();_data[key].key=key}_data[key].requests[workflow]=dataByWorkflow[workflow];_data[key].summary.updateFromRequestDoc(summaryBase)}var dataByWorkflow=requestData.getData();for(var workflow in dataByWorkflow){var key=_get(dataByWorkflow[workflow],_category,"NA");if(typeof key=="object"){for(var prop in key){_updateData(prop,key[prop])}}else{if(key=="NA"&&_category=="sites"||_category=="tasks"){_updateData(key,{})}else{_updateData(key,dataByWorkflow[workflow])}}}}function getData(key){if(key===undefined){return _data}else{return _data[key]}}function getRequestData(key){var requestData=WMStats.Requests();requestData.setDataByWorkflow(_data[key].requests);return requestData}function getList(sortFunc){var list=[];for(var key in _data){list.push(_data[key])}if(sortFunc){return list.sort(sortFunc)}else{return list}}return{categorize:categorize,getData:getData,getRequestData:getRequestData,category:_category,getList:getList}};WMStats.namespace("Agents");WMStats.Agents=function(couchData){var agentData=new WMStats._StructBase;agentData.convertCouchData=function(data){var dataRows=data.rows;var rows=[];for(var i in dataRows){var tableRow=dataRows[i].value;rows.push(tableRow)}return rows};if(couchData)agentData.setData(couchData);agentData.getAlertList=function(){var currentTime=Math.round((new Date).getTime()/1e3);var dataList=this.getData();var agentPollingCycle=600;function getStatus(agentInfo){var lastUpdatedDuration=currentTime-agentInfo.timestamp;if(lastUpdatedDuration>agentPollingCycle*2){return{status:"agent_down",message:WMStats.Utils.foramtDuration(lastUpdatedDuration)}}if(agentInfo.down_components.length>0){return{status:"component_down",message:agentInfo.down_components}}return{status:"ok",message:WMStats.Utils.foramtDuration(lastUpdatedDuration)}}for(var index in dataList){dataList[index]["alert"]=getStatus(dataList[index])}return dataList};return agentData};WMStats.namespace("Sites");WMStats.Sites=function(couchData){var _data;var baseColumns=["timestamp","site","agent_url"];var siteData=new WMStats._StructBase;siteData.convertCouchData=function(data){var dataRows=data.rows;var rows=[];for(var i in dataRows){var tableRow=dataRows[i].value;for(var j=0;j<baseColumns.length;j++){tableRow[baseColumns[j]]=dataRows[i].key[j]}rows.push(tableRow)}return rows};if(couchData)siteData.setData(couchData);return siteData};WMStats.namespace("JobSummary");WMStats.JobSummary=function(couchData){var jobSummaryData=new WMStats._StructBase;jobSummaryData.convertCouchData=function(data){var jobSummary={};jobSummary.status=[];for(var i in data.rows){jobSummary.workflow=data.rows[i].key[0];var statusSummary={};statusSummary.task=data.rows[i].key[1];statusSummary.status=data.rows[i].key[2];statusSummary.exitCode=data.rows[i].key[3];statusSummary.site=data.rows[i].key[4];if(typeof statusSummary.site==="object"){statusSummary.site="{}"}statusSummary.errorMsg=data.rows[i].key[5];statusSummary.count=data.rows[i].value;jobSummary.status.push(statusSummary)}return jobSummary};if(couchData)jobSummaryData.setData(couchData);return jobSummaryData};WMStats.namespace("Campaigns");WMStats.Campaigns=function(couchData){var campaignData=new WMStats._StructBase;var _baseColumns=["campaign"];campaignData.convertCouchData=function(data){dataRows=data.rows;var rows=[];for(var i in dataRows){var tableRow=dataRows[i].value;for(var j=0;j<_baseColumns.length;j++){tableRow[_baseColumns[j]]=dataRows[i].key[j]}rows.push(tableRow)}return rows};if(couchData)campaignData.setData(couchData);return campaignData};WMStats.namespace("Alerts");WMStats.Alerts=function(couchData){var alertData=new WMStats._StructBase;alertData.convertCouchData=function(data){var dataRows=data.rows;var rows=[];for(var i in dataRows){var tableRow={};tableRow.workflow=dataRows[i].key;tableRow.count=dataRows[i].value;rows.push(tableRow)}return rows};if(couchData)alertData.setData(couchData);return alertData};WMStats.namespace("SiteSummary");WMStats.SiteSummary=function(){var siteSummary={totalEvents:0,processedEvents:0,numRequests:0};var siteSummary=new WMStats.GenericRequestsSummary(siteSummary);siteSummary.createSummaryFromRequestDoc=function(doc){var summary=WMStats.SiteSummary();summary.summaryStruct.totalEvents=Number(this._get(doc,"input_events",0));summary.summaryStruct.processedEvents=this._get(doc,"output_progress.0.events",0);summary.summaryStruct.numRequests=1;summary.jobStatus=doc;if(typeof summary.jobStatus.cooloff==="number"){summary.jobStatus.cooloff={create:0,submit:0,job:summary.jobStatus.cooloff}}return summary};return siteSummary};WMStats.namespace("JobDetails");WMStats.JobDetails=function(couchData){var jobDetailData=new WMStats._StructBase;jobDetailData.convertCouchData=function(data){var dataRows=data.rows;var jobDetails=[];for(var i in dataRows){jobDetails.push(dataRows[i].doc)}return jobDetails};if(couchData)jobDetailData.setData(couchData);return jobDetailData};WMStats.namespace("WorkloadSummary");WMStats.WorkloadSummary=function(couchData){var workloadSummaryData=new WMStats._StructBase;workloadSummaryData.convertCouchData=function(data){var dataRows=data.rows;var workloadSummary=[];for(var i in dataRows){workloadSummary.push(dataRows[i].doc)}return workloadSummary};if(couchData)workloadSummaryData.setData(couchData);return workloadSummaryData};WMStats.namespace("History");WMStats.namespace("TimeBucket");WMStats.TimeBucket=function(){var _bucket=new Array;var _bucketSize=24;var _interval=3600;function addRow(currentTime,row){var timestamp=row.key[0];var couchDoc=row.doc;var index=parseInt((currentTime-timestamp)/3600);var updateFlag=false;if(_bucket[index]&&_bucket[index][couchDoc.agent_url]){if(_bucket[index][couchDoc.agent_url].timestamp<couchDoc.timestamp){updteFlag=true}}else if(_bucket[index]){updateFlag=true}else{_bucket[index]={};_bucket[index][couchDoc.agent_url]={};_bucket[index][couchDoc.agent_url].requests={};updateFlag=true}if(updateFlag){_bucket[index][couchDoc.agent_url].timestamp=couchDoc.timestamp;_bucket[index][couchDoc.agent_url].requests[couchDoc.workflow]=couchDoc}}function addHistory(couchData){var dataRows=couchData.rows;var currentTime=Math.round((new Date).getTime()/1e3);for(var i in dataRows){addRow(currentTime,dataRows[i])}}function getData(){return _bucket}return{addHistory:addHistory,getData:getData}};WMStats.History=function(couchData){var _data;var historyData=new WMStats._StructBase;historyData.convertCouchData=function(data){var bucket=WMStats.TimeBucket();bucket.addHistory(data);return bucket.getData()};if(couchData)historyData.setData(couchData);return historyData};WMStats.namespace("Requests");WMStats.namespace("RequestsSummary");WMStats.RequestsSummary=function(){var tier1Summary={totalEvents:0,processedEvents:0};var requestSummary=new WMStats.GenericRequestsSummary(tier1Summary);requestSummary.createSummaryFromRequestDoc=function(doc){var summary=WMStats.RequestsSummary();summary.summaryStruct.totalEvents=Number(this._get(doc,"input_events",0));summary.summaryStruct.processedEvents=this._get(doc,"output_progress.0.events",0);summary.summaryStruct.length=1;summary.jobStatus=this._get(doc,"status",{});if(typeof summary.jobStatus.cooloff==="number"){summary.jobStatus.cooloff={create:0,submit:0,job:summary.jobStatus.cooloff}}return summary};return requestSummary};WMStats.Requests=function(noFilterFlag){var tier1Requests=new WMStats.GenericRequests(noFilterFlag);var statusOrder={"new":1,"testing-approved":2,testing:3,tested:4,"test-failed":5,"assignment-approved":6,assigned:7,"ops-hold":8,negotiating:9,acquired:10,running:11,failed:12,"epic-FAILED":13,completed:14,"closed-out":15,announced:16,aborted:17,rejected:18};tier1Requests.estimateCompletionTime=function(request){var aData=this.getDataByWorkflow(request);var reqSummary=this.getSummary(request);var completedJobs=reqSummary.getJobStatus("success")+reqSummary.getTotalFailure();if(completedJobs==0)return-1;var requestStatus=this._get(aData,"request_status");var lastStatus=requestStatus[requestStatus.length-1];if(lastStatus.status!=="running")return 0;var totalJobs=reqSummary.getWMBSTotalJobs()-reqSummary.getJobStatus("canceled");var completionRatio=completedJobs/totalJobs;var queueInjectionRatio=reqSummary.getJobStatus("inWMBS")/this._get(aData,"total_jobs",1);var duration=Math.round(Date.now()/1e3)-lastStatus.update_time;var timeLeft=Math.round(duration/(completionRatio*queueInjectionRatio)-duration);return timeLeft};tier1Requests.requestNotPulledAlert=function(){var alertRequests=[];for(var workflow in this.getDataByWorkflow()){var reqStatusInfo=this.getRequestStatusAndTime(workflow);var currentTime=Math.round((new Date).getTime()/1e3);var timeThreshold=600;if(reqStatusInfo.status=="assigned"){if(currentTime-reqStatusInfo.update_time>timeThreshold){alertRequests.push({request:this.getData(workflow),message:"not pulled by GQ"})}}if(reqStatusInfo.status=="acquired"){if(currentTime-reqStatusInfo.update_time>timeThreshold){alertRequests.push({request:this.getData(workflow),message:"not pulled by LQ"})}}}return alertRequests};return tier1Requests};WMStats.namespace("CampaignSummary");WMStats.CampaignSummary=function(){var campaignSummary={totalEvents:0,processedEvents:0,numRequests:0};var campaignSummary=new WMStats.GenericRequestsSummary(campaignSummary);campaignSummary.createSummaryFromRequestDoc=function(doc){var summary=WMStats.CampaignSummary();summary.summaryStruct.totalEvents=Number(this._get(doc,"input_events",0));summary.summaryStruct.processedEvents=this._get(doc,"output_progress.0.events",0);summary.summaryStruct.numRequests=1;summary.jobStatus=this._get(doc,"status",{});if(typeof summary.jobStatus.cooloff==="number"){summary.jobStatus.cooloff={create:0,submit:0,job:summary.jobStatus.cooloff}}return summary};return campaignSummary};WMStats.namespace("Table");WMStats.Table=function(config,tableSetting){var tableSetting=tableSetting||'<table cellpadding="0" cellspacing="0" border="0.5" class="display" width="100%"></table>';var tableConfig={bStateSave:true,bProcessing:true,iDisplayLength:10,sDom:"lrtip",aaSorting:[],bAutoWidth:true,bJQueryUI:true};function updateConfig(config){for(var prop in config){tableConfig[prop]=config[prop]}}function _footer(){var footer="<tfoot><tr>";for(var i in tableConfig.aoColumns){if(tableConfig.aoColumns[i].bVisible!=false){footer+="<th>"+tableConfig.aoColumns[i]["sTitle"]+"</th>"}}footer+="</tr></tfoot>";return footer}function create(selector,filterConfig){$(selector).empty();$(selector).html(tableSetting);var oTable=$(selector+" table").dataTable(tableConfig);if(oTable.length>0){oTable.fnAdjustColumnSizing()}jQuery(WMStats.Globals.Event).triggerHandler(WMStats.CustomEvents.LOADING_DIV_END);if(filterConfig){return oTable.columnFilter(filterConfig)}else{return oTable}}if(config){updateConfig(config)}return{config:tableConfig,updateConfig:updateConfig,create:create}};WMStats.namespace("JobSummaryTable");WMStats.JobSummaryTable=function(data,containerDiv){var tableConfig={sDom:"lfrtip",aoColumns:[{mDataProp:function(source,type,val){if(type=="display"){return source.task}return source.task},sTitle:"task",sWidth:"150px"},{mDataProp:"status",sTitle:"status"},{mDataProp:"site",sTitle:"site"},{mDataProp:"exitCode",sTitle:"exit code"},{mDataProp:"count",sTitle:"jobs"},{mDataProp:"errorMsg",sTitle:"error mesage",sDefaultContent:""}],aaSorting:[[1,"asc"]]};tableConfig.aaData=data.getData().status;var filterConfig={};$(containerDiv).data("workflow",data.getData().workflow);return WMStats.Table(tableConfig).create(containerDiv,filterConfig)};WMStats.namespace("SiteSummaryTable");WMStats.SiteSummaryTable=function(data,containerDiv){var tableConfig={sDom:"lfrtip",sScrollX:"",aoColumns:[{sTitle:"D",sDefaultContent:0,fnRender:function(o,val){return WMStats.Utils.formatDetailButton("detail")}},{sTitle:"L",sDefaultContent:0,fnRender:function(o,val){return WMStats.Utils.formatDetailButton("drill")}},{mDataProp:"key",sTitle:"site"},{mDataProp:function(source,type,val){return source.summary.summaryStruct.numRequests},sTitle:"requests",sDefaultContent:0},{mDataProp:function(source,type,val){return source.summary.getJobStatus("submitted.pending")},sTitle:"pending",sDefaultContent:0},{mDataProp:function(source,type,val){return source.summary.getJobStatus("submitted.running")},sTitle:"running",sDefaultContent:0},{mDataProp:function(source,type,val){return source.summary.getTotalCooloff()},sTitle:"cool off",sDefaultContent:0},{sDefaultContent:0,sTitle:"failure rate",mDataProp:function(source,type,val){var failJobs=source.summary.getTotalFailure();var successJobs=source.summary.getJobStatus("success");var totalCompleteJobs=successJobs+failJobs||1;var result=failJobs/totalCompleteJobs*100;return result.toFixed(1)+"%"}}]};tableConfig.aaData=data.getList();var filterConfig={};return WMStats.Table(tableConfig).create(containerDiv,filterConfig)};WMStats.namespace("JobDetailList");(function(){var format=function(data){var jobDetails=data.getData();var requestData=WMStats.ActiveRequestModel.getData();var htmlstr='<div><nav id="jobDetailNav" class="button-group"><ul>';var jobDivIDPrefix="jobDetail-";for(var index in jobDetails){var buttonNumber=Number(index)+1;if(buttonNumber==1){htmlstr+='<li><a href="#'+jobDivIDPrefix+index+'" class="pageButton button-selected">'+buttonNumber+" </a></li>"}else{htmlstr+='<li><a href="#'+jobDivIDPrefix+index+'" class="pageButton button-unselected">'+buttonNumber+" </a></li>"}}htmlstr+="</nav></ul></div>";for(var index in jobDetails){var jobDoc=jobDetails[index];if(index==="0"){htmlstr+="<div class='jobDetailBox' id='"+jobDivIDPrefix+index+"'>"}else{htmlstr+="<div class='jobDetailBox hideDiv' id='"+jobDivIDPrefix+index+"'>"}htmlstr+="<ul>";htmlstr+="<li><b>Job Name:</b> "+jobDoc._id+"</li>";htmlstr+="<li><b>WMBS job id:</b> "+jobDoc.wmbsid+"</li>";htmlstr+="<li><b>Workflow:</b> "+jobDoc.workflow+"</li>";htmlstr+="<li><b>Task:</b> "+jobDoc.task+"</li>";htmlstr+="<li><b>Status:</b> "+jobDoc.state+"</li>";htmlstr+="<li><b>Input dataset:</b> "+requestData.getDataByWorkflow(jobDoc.workflow,"inputdataset","")+"</li>";if(typeof jobDoc.site=="object"){htmlstr+="<li><b>Site:</b> N/A </li>"}else{htmlstr+="<li><b>Site:</b> "+jobDoc.site+"</li>"}htmlstr+="<li><b>State Transition:</b>";for(var i in jobDoc.state_history){htmlstr+=jobDoc.state_history[i]["newstate"]+": "+jobDoc.state_history[i]["timestamp"];htmlstr+=", "}htmlstr+="</li>";htmlstr+="<li><b>Exit code:</b> "+jobDoc.exitcode+"</li>";htmlstr+="<li><b>Retry count:</b> "+jobDoc.retrycount+"</li>";htmlstr+="<li><b>Errors:</b> ";for(var errorType in jobDoc.errors){htmlstr+="<ul>";htmlstr+="<li><b>"+errorType+"</b></li>";for(var i in jobDoc.errors[errorType]){htmlstr+="<ul>";htmlstr+="<li><b>"+jobDoc.errors[errorType][i].type+" (Exit Code: "+jobDoc.errors[errorType][i].exitCode+")</b></li>";htmlstr+="<ul>";htmlstr+="<li><pre>"+jobDoc.errors[errorType][i].details+"</pre></li>";htmlstr+="</ul>";htmlstr+="</ul>"}htmlstr+="</ul>"}htmlstr+="</li>";htmlstr+="<li><b>Input Files:</b>";for(var i in jobDoc.inputfiles){htmlstr+=jobDoc.inputfiles[i].lfn+" ";htmlstr+="\n "}htmlstr+="</li>";htmlstr+="<li><b>Lumis:</b>";for(var i in jobDoc.lumis){for(var j in jobDoc.lumis[i]){htmlstr+=jobDoc.lumis[i][j]+" "}htmlstr+="\n "}htmlstr+="</li>";htmlstr+="<li><b>Output:</b> ";for(var i in jobDoc.output){htmlstr+="<ul>";htmlstr+="<li><b>"+jobDoc.output[i].type+"</b></li>";htmlstr+="<ul>";htmlstr+="<li><b>lfn:</b> "+jobDoc.output[i].lfn+"</li>";htmlstr+="<li><b>location:</b> ";htmlstr+=jobDoc.output[i].location;htmlstr+="</li>";htmlstr+="<li><b>checksums: adler32:</b> "+jobDoc.output[i].checksums.adler32+",<b>  cksum:</b> "+jobDoc.output[i].checksums.cksum+"</li>";htmlstr+="<li><b>size:</b> "+jobDoc.output[i].size+"</li>";htmlstr+="</ul>";htmlstr+="</ul>"}htmlstr+="</li>";htmlstr+="</ul>";htmlstr+="</div>"}return htmlstr};WMStats.JobDetailList=function(data,containerDiv){$(containerDiv).html(format(data))}})();WMStats.namespace("AgentStatusGUI");WMStats.AgentStatusGUI=function(data,containerDiv){var dataList=data.getAlertList();var collectiveStatus="ok";function setStatus(status){if(collectiveStatus=="ok"){collectiveStatus=status}else if(collectiveStatus=="warning"&&status=="error"){collectiveStatus="error"}}var htmlList="<ul>";for(var index in dataList){var statusInfo=dataList[index].alert;if(statusInfo.status=="agent_down"){setStatus("error");htmlList+="<li>"+dataList[index].agent_url+": "+statusInfo.message+"</li>"}else if(statusInfo.status=="component_down"){setStatus("warning");htmlList+="<li>"+dataList[index].agent_url+": "+statusInfo.message+"</li>"}}htmlList+="</ul>";if(collectiveStatus=="ok"){$(containerDiv).removeClass("warning error").addClass("stable")}else if(collectiveStatus=="warning"){$(containerDiv).removeClass("stable error").addClass("warning").html(htmlList)}else if(collectiveStatus=="error"){$(containerDiv).removeClass("stable warning").addClass("error").html(htmlList)}};WMStats.namespace("SiteHistoryGraph");WMStats.SiteHistoryGraph=function(historyData,containerDiv){var siteHistory=JSON.stringify(historyData);var htmlList="<pre>"+siteHistory+"</pre>";$(containerDiv).html(htmlList)};WMStats.namespace("Controls");WMStats.Controls=function($){var _filterSelector;var _categorySelector;function setFilter(selector){$(selector).append('<div name="filter">                            campaign: <input name="campaign" value=""></input>                            workflow: <input name="workflow" value=""></input>                            type: <input name="request_type" value=""></input>                            status: <input name="request_status" value=""></input>                            input dataset: <input name="inputdataset" value=""></input>                            output dataset: <input name="outputdatasets" value=""></input>                            site whitelist: <input name="site_white_list" value=""></input>                            agent: <input name="agent_url" value=""></input>                           </div>');_filterSelector=selector+' div[name="filter"] input'}function setCategoryButton(selector){var categoryBottons='<nav id="category_button" class="button-group">            <ul><li><a href="#campaign" class="nav-button nav-button-selected"> Campaign </a></li>                <li><a href="#sites" class="nav-button button-unselected"> Site </a></li></ul>         </nav>';$(selector).append(categoryBottons);WMStats.Env.CategorySelection="campaign"}function setAllRequestButton(selector){var requestBottons='<nav id="all_requests" class="button-group">            <ul><li><a href="#" class="nav-button"> all requests </a></li></ul>        </nav>';$(selector).append(requestBottons).addClass("button-group");WMStats.Env.RequestSelection="all_requests"}function getCategoryButtonValue(){return WMStats.Env.CategorySelection}function getFilter(){return WMStats.Utils.createInputFilter(_filterSelector)}function setTabs(selector){var tabs='<ul><li class="first"><a href="#category_view">Category</a></li>                    <li><a href="#request_view">&#187 Requests</a></li>                    <li><a href="#job_view">&#187 Jobs</a></li></ul>';$(selector).append(tabs).addClass("tabs");$(selector+" ul").addClass("tabs-nav")}return{setFilter:setFilter,setTabs:setTabs,setCategoryButton:setCategoryButton,setAllRequestButton:setAllRequestButton,getCategoryButtonValue:getCategoryButtonValue,getFilter:getFilter,requests:"requests",sites:"sites",campaign:"campaign"}}(jQuery);WMStats.namespace("ActiveRequestTable");WMStats.ActiveRequestTable=function(requestData,containerDiv){var formatReqDetailUrl=WMStats.Utils.formatReqDetailUrl;var formatWorkloadSummarylUrl=WMStats.Utils.formatWorkloadSummarylUrl;var tableConfig={iDisplayLength:25,sScrollX:"",sDom:"lrtip",bAutoWidth:false,aoColumns:[{sTitle:"D",sDefaultContent:0,sWidth:"15px",fnRender:function(o,val){return WMStats.Utils.formatDetailButton("detail")}},{sTitle:"L",sDefaultContent:0,sWidth:"15px",fnRender:function(o,val){return WMStats.Utils.formatDetailButton("drill")}},{mDataProp:"workflow",sTitle:"workflow",fnRender:function(o,val){return formatReqDetailUrl(o.aData.workflow)},bUseRendered:false,sWidth:"150px"},{mDataProp:function(source,type,val){return source.request_status[source.request_status.length-1].status},sTitle:"status",fnRender:function(o,val){return formatWorkloadSummarylUrl(o.aData.workflow,o.aData.request_status[o.aData.request_status.length-1].status)},bUseRendered:false},{mDataProp:"request_type",sTitle:"type",sDefaultContent:""},{mDataProp:"priority",sTitle:"priority",sDefaultContent:0},{sDefaultContent:0,sTitle:"queue injection",fnRender:function(o,val){var result=requestData.getDataByWorkflow(o.aData.workflow,"status.inWMBS",0)/requestData.getDataByWorkflow(o.aData.workflow,"total_jobs",1)*100;return result.toFixed(1)+"%"}},{sDefaultContent:0,sTitle:"job progress",fnRender:function(o,val){var reqSummary=requestData.getSummary(o.aData.workflow);var totalJobs=reqSummary.getWMBSTotalJobs()||1;var result=(reqSummary.getJobStatus("success")+reqSummary.getTotalFailure())/totalJobs*100;return result.toFixed(1)+"%"}},{sDefaultContent:0,sTitle:"event progress",fnRender:function(o,val){var inputEvents=Number(requestData.getDataByWorkflow(o.aData.workflow,"input_events",1))||1;var result=Number(requestData.getDataByWorkflow(o.aData.workflow,"output_progress.0.events",0))/inputEvents*100;return result.toFixed(1)+"%"}},{sDefaultContent:0,sTitle:"failure rate",fnRender:function(o,val){var reqSummary=requestData.getSummary(o.aData.workflow);var totalFailure=reqSummary.getTotalFailure();var totalJobs=reqSummary.getJobStatus("success")+totalFailure||1;var result=totalFailure/totalJobs*100;return result.toFixed(1)+"%"}},{sDefaultContent:0,sTitle:"Eestimated Completion",fnRender:function(o,val){return WMStats.Utils.foramtDuration(requestData.estimateCompletionTime(o.aData.workflow))}},{sDefaultContent:0,sTitle:"cool off ",fnRender:function(o,val){var reqSummary=requestData.getSummary(o.aData.workflow);return reqSummary.getTotalCooloff()}}]};var filterConfig={};tableConfig.aaData=requestData.getList();return WMStats.Table(tableConfig).create(containerDiv,filterConfig)};WMStats.namespace("CampaignSummaryTable");WMStats.CampaignSummaryTable=function(data,containerDiv){var tableConfig={sScrollX:"",aoColumns:[{sTitle:"D",sDefaultContent:0,fnRender:function(o,val){return WMStats.Utils.formatDetailButton("detail")}},{sTitle:"L",sDefaultContent:0,fnRender:function(o,val){return WMStats.Utils.formatDetailButton("drill")}},{mDataProp:"key",sTitle:"campaign"},{mDataProp:function(source,type,val){return source.summary.summaryStruct.numRequests},sTitle:"requests",sDefaultContent:0},{sDefaultContent:0,sTitle:"job progress",mDataProp:function(source,type,val){var campaignSummary=source.summary;var totalJobs=campaignSummary.getWMBSTotalJobs()||1;var result=(campaignSummary.getJobStatus("success")+campaignSummary.getTotalFailure())/totalJobs*100;return result.toFixed(1)+"%"}},{sDefaultContent:0,sTitle:"event progress",mDataProp:function(source,type,val){var totalEvents=source.summary.summaryStruct.totalEvents||1;var result=source.summary.summaryStruct.processedEvents/totalEvents*100;return result.toFixed(1)+"%"}},{sDefaultContent:0,sTitle:"failure rate",mDataProp:function(source,type,val){var campaignSummary=source.summary;var totalFailure=campaignSummary.getTotalFailure();var totalJobs=campaignSummary.getJobStatus("success")+totalFailure||1;var result=totalFailure/totalJobs*100;return result.toFixed(1)+"%"}},{sDefaultContent:0,sTitle:"cool off ",mDataProp:function(source,type,val){var campaignSummary=source.summary;return campaignSummary.getTotalCooloff()}}]};tableConfig.aaData=data.getList();var filterConfig={};return WMStats.Table(tableConfig).create(containerDiv,filterConfig)};WMStats.namespace("RequestDetailList");(function(){var format=function(requestStruct){var htmlstr='<div class="closingButton">X</div>';var reqDoc=requestStruct.requests[requestStruct.key];var reqSummary=requestStruct.summary;htmlstr+="<div class='requestDetailBox'>";htmlstr+="<ul>";if(reqDoc){htmlstr+="<li><b>campaign:</b> "+reqDoc.campaign+"</li>";htmlstr+="<li><b>workflow:</b> "+WMStats.Utils.formatReqDetailUrl(reqDoc.workflow)+"</li>";htmlstr+="<li><b>agent url:</b> "+reqDoc.agent_url+"</li>";htmlstr+="<li><b>teams:</b> "+reqDoc.teams+"</li>";htmlstr+="<li><b>requetor:</b> "+reqDoc.requestor+"</li>";htmlstr+="<li><b>request date:</b> "+reqDoc.request_date+"</li>";htmlstr+="<li><b>request type:</b> "+reqDoc.request_type+"</li>";htmlstr+="<li><b>user dn:</b> "+reqDoc.user_dn+"</li>";
htmlstr+="<li><b>vo role:</b> "+reqDoc.vo_role+"</li>";htmlstr+="<li><b>vo group:</b> "+reqDoc.vo_group+"</li>";htmlstr+="<li><b>status:</b> "+WMStats.Utils.formatWorkloadSummarylUrl(reqDoc.workflow,reqDoc.request_status[reqDoc.request_status.length-1].status)+"</li>";htmlstr+="<li><b>input dataset:</b> "+reqDoc.inputdataset+"</li>";htmlstr+="<li><b>input events:</b> "+reqDoc.input_events+"</li>";htmlstr+="<li><b>site white list:</b> "+reqDoc.site_white_list+"</li>";htmlstr+="<li><b>output datasets:</b> "+reqDoc.outputdatasets+"</li>"}if(reqSummary){htmlstr+="<li><b>output events:</b> "+reqSummary.summaryStruct.processedEvents+"</li>";htmlstr+="<li><b>queued (first):</b> "+reqSummary.getJobStatus("queued.first",0)+"</li>";htmlstr+="<li><b>queued (retried):</b> "+reqSummary.getJobStatus("queued.retry",0)+"</li>";htmlstr+="<li><b>cooloff jobs:</b> "+reqSummary.getTotalCooloff()+"</li>";htmlstr+="<li><b>pending:</b> "+reqSummary.getJobStatus("submitted.pending",0)+"</li>";htmlstr+="<li><b>running:</b> "+reqSummary.getJobStatus("submitted.running",0)+"</li>";htmlstr+="<li><b>failure:</b>"+reqSummary.getTotalFailure()+"</li>";htmlstr+="<li><b>success:</b> "+reqSummary.getJobStatus("success",0)+"</li>"}htmlstr+="</ul>";htmlstr+="</div>";return htmlstr};WMStats.RequestDetailList=function(data,containerDiv){$(containerDiv).html(format(data))}})();WMStats.namespace("RequestAlertGUI");WMStats.RequestAlertGUI=function(requestData,containerDiv){var alertRequests=requestData.getAlertRequests();var notPulledRequests=requestData.requestNotPulledAlert();if(alertRequests.length>0||notPulledRequests.length>0){var htmlList="<ul>";for(var i in alertRequests){var key=alertRequests[i].key;var summary=alertRequests[i].summary;var jobs=summary.getTotalPaused()+summary.getTotalCooloff();htmlList+='<li> <a class="requestAlert">'+key+"</a>:"+jobs+"</li>"}for(var i in notPulledRequests){var key=notPulledRequests[i].request.key;htmlList+="<li>"+key+":"+notPulledRequests[i].message+"</li>"}htmlList+="</ul>";$(containerDiv).removeClass("stable warning").addClass("error").html(htmlList)}else{$(containerDiv).removeClass("warning error").addClass("stable").html("request alarm")}};WMStats.namespace("CategoryDetailList");(function(){var format=function(requestStruct){var htmlstr="";var reqDoc=requestStruct.requests[requestStruct.key];var reqSummary=requestStruct.summary;htmlstr+="<div class='requestDetailBox'>";htmlstr+="<ul>";if(reqDoc){htmlstr+="<li><b>campaign:</b> "+reqDoc.campaign+"</li>";htmlstr+="<li><b>workflow:</b> "+WMStats.Utils.formatReqDetailUrl(reqDoc.workflow)+"</li>";htmlstr+="<li><b>requetor:</b> "+reqDoc.requestor+"</li>";htmlstr+="<li><b>request date:</b> "+reqDoc.request_date+"</li>";htmlstr+="<li><b>request type:</b> "+reqDoc.request_type+"</li>";htmlstr+="<li><b>user dn:</b> "+reqDoc.user_dn+"</li>";htmlstr+="<li><b>vo role:</b> "+reqDoc.vo_role+"</li>";htmlstr+="<li><b>vo group:</b> "+reqDoc.vo_group+"</li>";htmlstr+="<li><b>status:</b> "+WMStats.Utils.formatWorkloadSummarylUrl(reqDoc.workflow,reqDoc.request_status[reqDoc.request_status.length-1].status)+"</li>";htmlstr+="<li><b>input dataset:</b> "+reqDoc.inputdataset+"</li>";htmlstr+="<li><b>input events:</b> "+reqDoc.input_events+"</li>";htmlstr+="<li><b>site white list:</b> "+reqDoc.site_white_list+"</li>";htmlstr+="<li><b>output datasets:</b> "+reqDoc.outputdatasets+"</li>"}if(reqSummary){htmlstr+="<li><b>output events:</b> "+reqSummary.summaryStruct.processedEvents+"</li>";htmlstr+="<li><b>queued (first):</b> "+reqSummary.getJobStatus("queued.first",0)+"</li>";htmlstr+="<li><b>queued (retried):</b> "+reqSummary.getJobStatus("queued.retry",0)+"</li>";htmlstr+="<li><b>cooloff jobs:</b> "+reqSummary.getTotalCooloff()+"</li>";htmlstr+="<li><b>pending:</b> "+reqSummary.getJobStatus("submitted.pending",0)+"</li>";htmlstr+="<li><b>running:</b> "+reqSummary.getJobStatus("submitted.running",0)+"</li>";htmlstr+="<li><b>failure:</b>"+reqSummary.getTotalFailure()+"</li>";htmlstr+="<li><b>success:</b> "+reqSummary.getJobStatus("success",0)+"</li>"}htmlstr+="</ul>";htmlstr+="</div>";return htmlstr};WMStats.CategoryDetailList=function(data,containerDiv){$(containerDiv).html(format(data))}})();WMStats.namespace("RequestSummaryList");(function(){var format=function(summary){var summaryStruct=summary.summaryStruct;htmlstr="";htmlstr+="<div class='requestSummaryBox'>";htmlstr+="<ul>";htmlstr+="<li><b>requests:</b> "+summary.summaryStruct.length+"</li>";htmlstr+="<li><b>total events:</b> "+summary.summaryStruct.totalEvents+"</li>";htmlstr+="<li><b>processed events:</b> "+summary.summaryStruct.processedEvents+"</li>";htmlstr+="<li><b>created:</b> "+summary.getWMBSTotalJobs()+"</li>";htmlstr+="<li><b>cooloff:</b> "+summary.getTotalCooloff()+"</li>";htmlstr+="<li><b>success:</b> "+summary.getJobStatus("success")+"</li>";htmlstr+="<li><b>failure:</b> "+summary.getTotalFailure()+"</li>";htmlstr+="<li><b>queued:</b> "+summary.getTotalQueued()+"</li>";htmlstr+="<li><b>running:</b> "+summary.getJobStatus("submitted.running")+"</li>";htmlstr+="<li><b>pending:</b> "+summary.getJobStatus("submitted.pending")+"</li>";htmlstr+="</ul>";htmlstr+="</div>";return htmlstr};WMStats.RequestSummaryList=function(data,containerDiv){$(containerDiv).html(format(data))}})();WMStats.namespace("RequestDataList");(function(){var format=function(summary){var summaryStruct=summary.summaryStruct;htmlstr="";htmlstr+="<div class='requestSummaryBox'>";htmlstr+="<ul>";htmlstr+="<li> requests: "+summary.summaryStruct.length+"</li>";htmlstr+="<li> total events: "+summary.summaryStruct.totalEvents+"</li>";htmlstr+="<li> processed events: "+summary.summaryStruct.processedEvents+"</li>";htmlstr+="<li> created: "+summary.getWMBSTotalJobs()+"</li>";htmlstr+="<li> cooloff: "+summary.getTotalCooloff()+"</li>";htmlstr+="<li> success: "+summary.getJobStatus("success")+"</li>";htmlstr+="<li> failure: "+summary.getTotalFailure()+"</li>";htmlstr+="<li> queued: "+summary.getTotalQueued()+"</li>";htmlstr+="<li> running: "+summary.getJobStatus("submitted.running")+"</li>";htmlstr+="<li> pending: "+summary.getJobStatus("submitted.pending")+"</li>";htmlstr+="</ul>";htmlstr+="</div>";return htmlstr};WMStats.RequestDataList=function(data,containerDiv){$(containerDiv).html(format(data))}})();WMStats.namespace("_ModelBase");WMStats._ModelBase=function(initView,options,dataStruct){this._initialView=initView;this._options=options;this._dataStruct=dataStruct;this._trigger=null;this._data=null;this._dbSource=WMStats.Couch};WMStats._ModelBase.prototype={setTrigger:function(triggerName){this._trigger=triggerName},getData:function(){return this._data},dataReady:function(data){this._data=this._dataStruct(data);if(this._trigger instanceof Array){for(var i in this._trigger){jQuery(WMStats.Globals.Event).triggerHandler(this._trigger[i],this._data)}}else{jQuery(WMStats.Globals.Event).triggerHandler(this._trigger,this._data)}},retrieveData:function(){return this._dbSource.view(this._initialView,this._options,jQuery.proxy(this.callback,this))},retrieveAllDocs:function(){return this._dbSource.allDocs(this._options,jQuery.proxy(this.callback,this))},setDBSource:function(dbSource){this._dbSource=dbSource},callback:function(data){return this.dataReady(data)},clearData:function(){delete this._data}};WMStats.namespace("_RequestModelBase");WMStats._RequestModelBase=function(initView,options){this._initialView=initView||"requestByCampaignAndDate";this._options=options||{include_docs:true};this._data=null;this._trigger="requestReady"};WMStats._RequestModelBase.keysFromIDs=function(data){var keys=[];for(var i in data.rows){if(data.rows[i].value&&data.rows[i].value.id){keys.push(data.rows[i].value.id)}else{keys.push(data.rows[i].id)}}return keys};WMStats._RequestModelBase.requestAgentUrlKeys=function(requestList,requestAgentData){var keys={};var requestAgentUrlList=[];for(var i in requestAgentData.rows){var request=requestAgentData.rows[i].key[0];if(!keys[request]){keys[request]=[]}keys[request].push(requestAgentData.rows[i].key[1])}for(var j=0;j<requestList.length;j++){for(var k in keys[requestList[j]]){requestAgentUrlList.push([requestList[j],keys[requestList[j]][k]])}}return requestAgentUrlList};WMStats._RequestModelBase.prototype={setTrigger:function(triggerName){this._trigger=triggerName},getData:function(){return this._data},getRequests:function(){return this._data},_getRequestDetailsAndTriggerEvent:function(agentIDs,reqmgrData,objPtr){var options={keys:WMStats._RequestModelBase.keysFromIDs(agentIDs),reduce:false,include_docs:true};WMStats.Couch.allDocs(options,function(agentData){jQuery(WMStats.Globals.Event).triggerHandler(WMStats.CustomEvents.LOADING_DIV_START);var requestCache=WMStats.Requests();requestCache.updateBulkRequests(reqmgrData.rows);requestCache.updateBulkRequests(agentData.rows);objPtr._data=requestCache;jQuery(WMStats.Globals.Event).triggerHandler(objPtr._trigger,objPtr._data)})},_getLatestRequestAgentUrlAndCreateTable:function(overviewData,keys,objPtr){var options={keys:keys,reduce:true,group:true,descending:true};WMStats.Couch.view("latestRequest",options,function(agentIDs){objPtr._getRequestDetailsAndTriggerEvent(agentIDs,overviewData,objPtr)})},_getLatestRequestIDsAndCreateTable:function(overviewData,objPtr){var options={reduce:true,group:true,descending:true};var requestList=WMStats._RequestModelBase.keysFromIDs(overviewData);WMStats.Couch.view("requestAgentUrl",options,function(requestAgentUrlData){var keys=WMStats._RequestModelBase.requestAgentUrlKeys(requestList,requestAgentUrlData);objPtr._getLatestRequestAgentUrlAndCreateTable(overviewData,keys,objPtr)})},retrieveData:function(viewName,options){if(!viewName){viewName=this._initialView}if(!options){options=WMStats.Utils.cloneObj(this._options)}var objPtr=this;if(viewName=="allDocs"){WMStats.Couch.allDocs(options,function(overviewData){objPtr._getLatestRequestIDsAndCreateTable(overviewData,objPtr)})}else{WMStats.Couch.view(viewName,options,function(overviewData){objPtr._getLatestRequestIDsAndCreateTable(overviewData,objPtr)})}},clearRequests:function(){delete this._data}};WMStats.namespace("JobSummaryModel");WMStats.JobSummaryModel=new WMStats._ModelBase("jobsByStatusWorkflow",{},WMStats.JobSummary);WMStats.JobSummaryModel.setRequest=function(workflow){this._options={reduce:true,group_level:6,startkey:[workflow],endkey:[workflow,{}]}};WMStats.JobSummaryModel.setTrigger([WMStats.CustomEvents.JOB_SUMMARY_READY,WMStats.CustomEvents.LOADING_DIV_END]);WMStats.namespace("JobDetailModel");WMStats.JobDetailModel=new WMStats._ModelBase("jobsByStatusWorkflow",{},WMStats.JobDetails);WMStats.JobDetailModel.setOptions=function(summary){var startkey=null;if(typeof summary.site=="object"){startkey=[summary.workflow,summary.task,summary.status,summary.exitCode]}else{startkey=[summary.workflow,summary.task,summary.status,summary.exitCode,summary.site]}this._options={include_docs:true,reduce:false,startkey:startkey,endkey:[summary.workflow,summary.task,summary.status,summary.exitCode,summary.site,{}],limit:10}};WMStats.JobDetailModel.setTrigger([WMStats.CustomEvents.JOB_DETAIL_READY,WMStats.CustomEvents.LOADING_DIV_END]);WMStats.namespace("AgentModel");WMStats.AgentModel=new WMStats._ModelBase("agentInfo",{},WMStats.Agents);WMStats.AgentModel.setTrigger(WMStats.CustomEvents.AGENTS_LOADED);WMStats.namespace("WorkloadSummaryOutputdataModel");WMStats.WorkloadSummaryOutputdataModel=new WMStats._ModelBase("summaryByOutputdataset",{reduce:false,include_docs:true},WMStats.WorkloadSummary);WMStats.WorkloadSummaryOutputdataModel.setKey=function(key){this._options={include_docs:true,reduce:false,key:key}};WMStats.WorkloadSummaryOutputdataModel.setDBSource(WMStats.WorkloadSummaryCouch);WMStats.namespace("HistoryModel");WMStats.HistoryModel=new WMStats._ModelBase("requestHistory",{},WMStats.History);WMStats.HistoryModel.setOptions=function(){var current=Math.round((new Date).getTime()/1e3);this._options={reduce:false,startkey:[current,{}],endkey:[current-600*60*24],include_docs:true,descending:true}};WMStats.HistoryModel.setTrigger(WMStats.CustomEvents.HISTORY_LOADED);WMStats.namespace("ActiveRequestModel");WMStats.ActiveRequestModel=function(){var initView="requestByStatus";var options={keys:["new","assignment-approved","assigned","ops-hold","negotiating","acquired","running","failed","epic-FAILED","completed","closed-out","announced","aborted","rejected"],include_docs:true};var reqModel=new WMStats._RequestModelBase(initView,options);reqModel.setTrigger(WMStats.CustomEvents.REQUESTS_LOADED);return reqModel}();WMStats.namespace("Env");WMStats.Env.View="#category_view";WMStats.Env.CategorySelection=null;WMStats.Env.RequestSelection="all_requests";WMStats.Env.CategoryData=null;WMStats.Env.CurrentRequestData=null;WMStats.Env.RequestDetailOpen=false;WMStats.namespace("GenericController");(function($){function closeRequestDetail(){$("#request_view div.detail_data").hide("puff",{},500);WMStats.Env.RequestDetailOpen=false}$(document).on("click","div.caption img",function(event){$(this).parent("div.caption").siblings("div.body").toggle("nomal")});$(document).on("click","div.closingButton",function(event){closeRequestDetail();event.preventDefault()});$(document).keyup(function(event){if(WMStats.Env.RequestDetailOpen&&event.keyCode==27){closeRequestDetail();event.preventDefault()}});WMStats.GenericController.switchView=function(showSelector,hideSelectors){if(!showSelector){showSelector=WMStats.Env.View}else if(!hideSelectors){var viewList=["#category_view","#request_view","#job_view"];for(var i in viewList){if(showSelector!=viewList[i]){$(viewList[i]).hide()}}}else{for(var i in hideSelectors){$(hideSelectors[i]).hide()}}$(showSelector).show();WMStats.Env.View=showSelector;$("#tab_board li").removeClass("tabs-selected");$('#tab_board a[href="'+showSelector+'"]').parent().addClass("tabs-selected")}})(jQuery);WMStats.namespace("ActiveRequestController");function getActiveFilteredData(cacheFlag){var requestData=WMStats.ActiveRequestModel.getRequests();if(cacheFlag){return requestData.getFilteredRequests()}else{return filterRequests(requestData)}}function filterRequests(requestData){var filter=WMStats.Controls.getFilter();requestData.setFilter(filter);var filteredData=requestData.filterRequests();return filteredData}function getCategorizedData(category){var categoryData;if(category!=WMStats.Controls.requests){var filteredData=getActiveFilteredData(true);var summaryStruct=WMStats.CategorySummaryMap.get(category);categoryData=WMStats.RequestsByKey(category,summaryStruct);categoryData.categorize(filteredData);WMStats.Env.CategoryData=categoryData}else{categoryData=filterRequests(WMStats.Env.CurrentRequestData)}return categoryData}(function($){var E=WMStats.CustomEvents;function drawTotalRequestSummary(){var requestData=WMStats.ActiveRequestModel.getRequests();WMStats.RequestSummaryList(requestData.getSummary(),"#summary_board")}function drawFilteredRequestSummary(){var filteredData=getActiveFilteredData(true);WMStats.RequestSummaryList(filteredData.getSummary(),"#filter_summary")}function drawDataBoard(viewSelector){if(!viewSelector){viewSelector=WMStats.Env.View}WMStats.GenericController.switchView(viewSelector);var divSelector=viewSelector+" div.summary_data";var category=null;if(viewSelector==="#category_view"){category=WMStats.Env.CategorySelection}else if(viewSelector==="#request_view"){category=WMStats.Controls.requests}if(category){var data=getCategorizedData(category);var view=WMStats.CategoryTableMap.get(category);view(data,divSelector)}}$(WMStats.Globals.Event).on(E.REQUESTS_LOADED,function(event,requestData){var requestData=WMStats.ActiveRequestModel.getRequests();WMStats.RequestAlertGUI(requestData,"#request_alert");drawTotalRequestSummary();getActiveFilteredData();drawFilteredRequestSummary();if(WMStats.Env.CurrentRequestData===null||WMStats.Env.RequestSelection==="all_requests"){WMStats.Env.CurrentRequestData=requestData.getFilteredRequests()}drawDataBoard()});$(WMStats.Globals.Event).on(E.AGENTS_LOADED,function(event,agentData){WMStats.AgentStatusGUI(agentData,"#agent_alert")});$(WMStats.Globals.Event).on(E.CATEGORY_SUMMARY_READY,function(event,data){$("#category_view div.detail_data").empty();drawDataBoard("#category_view")});$(WMStats.Globals.Event).on(E.REQUEST_SUMMARY_READY,function(event,data){$("#request_view div.detail_data").empty();WMStats.Env.CurrentRequestData=data;drawDataBoard("#request_view")});$(WMStats.Globals.Event).on(E.JOB_SUMMARY_READY,function(event,data){$("#job_view div.detail_data").empty();WMStats.JobSummaryTable(data,"#job_view div.summary_data");WMStats.GenericController.switchView("#job_view")});$(WMStats.Globals.Event).on(E.CATEGORY_DETAIL_READY,function(event,categoryKey){var allData=WMStats.Env.CategoryData;var data=allData.getData(categoryKey);WMStats.CategoryDetailList(data,"#category_view div.detail_data")});$(WMStats.Globals.Event).on(E.REQUEST_DETAIL_READY,function(event,workflow){var allRequests=WMStats.ActiveRequestModel.getRequests();var reqDoc=allRequests.getDataByWorkflow(workflow);var reqSummary=allRequests.getSummary(workflow);var requests={};requests[workflow]=reqDoc;var data={key:workflow,requests:requests,summary:reqSummary};WMStats.RequestDetailList(data,"#request_view div.detail_data");$("#request_view div.detail_data").show("slide",{},500);WMStats.Env.RequestDetailOpen=true});$(WMStats.Globals.Event).on(E.JOB_DETAIL_READY,function(event,data){WMStats.JobDetailList(data,"#job_view div.detail_data")});$(document).on("keyup","#filter_board input",function(){getActiveFilteredData();drawFilteredRequestSummary();drawDataBoard()});$(document).on("click","#category_button li a",function(event){WMStats.Env.CategorySelection=this.hash.substring(1);$(WMStats.Globals.Event).triggerHandler(E.CATEGORY_SUMMARY_READY);$("#category_button li a").removeClass("nav-button-selected").addClass("button-unselected");$(this).removeClass("button-unselected").addClass("nav-button-selected");event.preventDefault()});$(document).on("click","#all_requests li a",function(event){WMStats.Env.RequestSelection="all_requests";var data=WMStats.ActiveRequestModel.getRequests();$(WMStats.Globals.Event).triggerHandler(E.REQUEST_SUMMARY_READY,data);$(this).removeClass("button-unselected").addClass("nav-button-selected");event.preventDefault()});$(document).on("click","a.requestAlert",function(){var workflow=$(this).text();WMStats.JobSummaryModel.setRequest(workflow);$(WMStats.Globals.Event).triggerHandler(E.AJAX_LOADING_START);WMStats.JobSummaryModel.retrieveData();$(this).addClass("reviewed")});$(document).on("click","#tab_board li a",function(event){drawDataBoard(this.hash);event.preventDefault()});$(document).on("click","#jobDetailNav li a",function(event){$("div.jobDetailBox").hide();$(this.hash).show();$("#jobDetailNav li a").removeClass("button-selected").addClass("button-unselected");$(this).removeClass("button-unselected").addClass("button-selected");event.preventDefault()});$(WMStats.Globals.Event).on(E.LOADING_DIV_START,function(event,data){if(WMStats.Env.View==="#category_view"||WMStats.Env.View==="#request_view"&&WMStats.Env.RequestSelection==="all_requests"){$("#loading_page").show()}});$(WMStats.Globals.Event).on(E.LOADING_DIV_END,function(event,data){$("#loading_page").hide()});$(WMStats.Globals.Event).on(E.AJAX_LOADING_START,function(event,data){$("#loading_page").show()})})(jQuery);WMStats.namespace("CategorySummaryMap");WMStats.namespace("CategoryTableMap");WMStats.CategorySummaryMap=function(){var summaryMap={};function add(category,summaryFunc){summaryMap[category]=summaryFunc}function get(category){return summaryMap[category]}return{add:add,get:get}}();WMStats.CategoryTableMap=function(){var tableMap={};function add(category,view){tableMap[category]=view}function get(category,view){return tableMap[category]}return{add:add,get:get}}();WMStats.CategorySummaryMap.add(WMStats.Controls.sites,WMStats.SiteSummary);WMStats.CategoryTableMap.add(WMStats.Controls.sites,WMStats.SiteSummaryTable);WMStats.CategoryTableMap.add(WMStats.Controls.requests,WMStats.ActiveRequestTable);(function($){var E=WMStats.CustomEvents;var COL_INDEX={};function TableEventHandler(containerID,populateRequestTable){this.containerID=containerID;if(populateRequestTable){this.populateRequestTable=populateRequestTable}}TableEventHandler.highlightRow=function(selector,currenElement){$(selector).removeClass("mouseclickRow");$(currenElement).addClass("mouseclickRow")};TableEventHandler.prototype={constructor:TableEventHandler,tableRowBind:function(bind,parentSelector,func){var currentObj=this;var selector=parentSelector+" table tbody tr";$(selector).live(bind,function(){TableEventHandler.highlightRow(selector,this);currentObj[func](this)})},tableColumnBind:function(bind,parentSelector,name,func){var currentObj=this;var selector=parentSelector+' table tbody tr td div[name="'+name+'"]';var rowSelector=parentSelector+" table tbody tr";$(document).on(bind,selector,function(){var currentRow=$(this).closest("tr");TableEventHandler.highlightRow(rowSelector,currentRow);currentObj[func](currentRow);event.preventDefault()})},populateRequestSummary:function(currentElement){var nTds=$("td",currentElement);var categoryKey=$(nTds[2]).text();var category=WMStats.Controls.getCategoryButtonValue();var categoryData=getCategorizedData(category);var requestData=categoryData.getRequestData(categoryKey);WMStats.Env.RequestSelection="partial_requests";$(WMStats.Globals.Event).triggerHandler(E.REQUEST_SUMMARY_READY,requestData);$("#all_requests li a").removeClass("nav-button-selected").addClass("button-unselected")},populateJobSummary:function(currentElement){var nTds=$("td",currentElement);var requestName=$(nTds[2]).text();WMStats.JobSummaryModel.setRequest(requestName);$(WMStats.Globals.Event).triggerHandler(E.AJAX_LOADING_START);WMStats.JobSummaryModel.retrieveData()},populateRequestDetail:function(currentElement){var nTds=$("td",currentElement);var workflowName=$(nTds[2]).text();$(WMStats.Globals.Event).triggerHandler(E.REQUEST_DETAIL_READY,workflowName)},populateCategoryDetail:function(currentElement){var nTds=$("td",currentElement);var categoryKey=$(nTds[2]).text();$(WMStats.Globals.Event).triggerHandler(E.CATEGORY_DETAIL_READY,categoryKey)},populateJobDetail:function(currentElement){var nTds=$("td",currentElement);var summary={};summary.workflow=$("#job_view div.summary_data").data("workflow");summary.task=$(nTds[0]).text();summary.status=$(nTds[1]).text();summary.site=$(nTds[2]).text();if(summary.site==="{}"){summary.site={}}summary.exitCode=Number($(nTds[3]).text());WMStats.JobDetailModel.setOptions(summary);$(WMStats.Globals.Event).triggerHandler(E.AJAX_LOADING_START);WMStats.JobDetailModel.retrieveData()}};var ActiveModelHandler=new TableEventHandler;ActiveModelHandler.tableColumnBind("click","#category_view div.summary_data","drill","populateRequestSummary");ActiveModelHandler.tableColumnBind("click","#request_view div.summary_data","drill","populateJobSummary");ActiveModelHandler.tableRowBind("click","#job_view div.summary_data","populateJobDetail");ActiveModelHandler.tableColumnBind("click","#category_view div.summary_data","detail","populateCategoryDetail");ActiveModelHandler.tableColumnBind("click","#request_view div.summary_data","detail","populateRequestDetail");$("tr").live("mouseover",function(event){$(this).addClass("mouseoverRow")});$("tr").live("mouseout",function(event){$(this).removeClass("mouseoverRow")})})(jQuery);WMStats.CategorySummaryMap.add(WMStats.Controls.campaign,WMStats.CampaignSummary);WMStats.CategoryTableMap.add(WMStats.Controls.campaign,WMStats.CampaignSummaryTable);